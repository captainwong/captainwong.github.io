---
layout: post
title:  "建站（三）"
subtitle: "Laravel 学习笔记"
date:   "2018-10-10" 
author: "cj"
tags:
    PHP
    Laravel
    Homestead
    VirtualBox
    npm
    yarn
---

# [Laravel-China 教程](https://laravel-china.org/courses) 学习笔记

## 1. 环境搭建

### 简略步骤

1. 安装 VirtualBox
2. 安装 Vagrant
3. 导入 Homestead Box 虚拟机盒子
4. 安装 Git
5. 安装 Homestead 管理脚本
6. 配置 Homestead.yaml 文件
7. 启动 Homestead 虚拟机

### 导入 Homestead Box 虚拟机盒子

下载[Homestead 虚拟机盒子](http://download.fsdhub.com/lc-homestead-6.1.1-2018090400.zip), 解压后运行命令

```cmd
vagrant box add metadata.json
```

### 安装 Homestead 管理脚本

使用git-bash运行

``` bash
cd ~
git clone https://git.coding.net/summerblue/homestead.git Homestead
cd Homestead
git checkout v7.8.0
bash init.sh
```

## 2. 解决 Windows 系统使用 Homestead 运行 Laravel 本地项目响应缓慢问题

参考 [Speeding up Homestead on Windows Using NFS](https://websanova.com/blog/laravel/speeding-up-homestead-on-windows-using-nfs)

### a. Install NFS Plugin

```cmd
vagrant plugin install vagrant-winnfsd
```

### b. Update homestead.rb

>There is some weird bug here, not sure why it hasn't been pushed into the main repo yet, but you will need to replace some code here (if not already live).
>
> **homestead/scripts/homestead.rb**
>
>Replace the following:
>

``` ruby
if settings.include? 'folders'
  settings["folders"].each do |folder|
    mount_opts = []

    if (folder["type"] == "nfs")
      mount_opts = folder["mount_opts"] ? folder["mount_opts"] : ['actimeo=1']
    end

    config.vm.synced_folder folder["map"], folder["to"], type: folder["type"] ||= nil, mount_options: mount_opts
  end
end
```

>With this:
>

``` ruby
if settings.include? 'folders'
  settings["folders"].sort! { |a,b| a["map"].length <=> b["map"].length }

  settings["folders"].each do |folder|
    config.vm.synced_folder folder["map"], folder["to"], 
    id: folder["map"],
    :nfs => true,
    :mount_options => ['nolock,vers=3,udp,noatime']
  end
end
```

### c. Update Homestead.yaml

>We can now use nfs in the folders section of the homestead config file.

``` yaml
folders:
    - map: ~\projects
      to: /home/vagrant/Code
      type: nfs
```

### d. 重启homestead

``` cmd
vagrant reload
```

## 3. 镜像加速

参考[https://laravel-china.org/composer](https://laravel-china.org/composer)

```bash
composer config -g repo.packagist composer https://packagist.laravel-china.org
yarn config set registry http://registry.cnpmjs.org
```

## 4. 创建项目

```bash
composer create-project laravel/laravel your-project-name --prefer-dist "5.7.*"
composer install
yarn install --no-bin-links
```

## 5. 解决`yarn install`问题

打开`pakage.json`, 去掉四处`cross-env`

```json
{
    "private": true,
    "scripts": {
        "dev": "npm run development",
        "development": "cross-env NODE_ENV=development node_modules/webpack/bin/webpack.js --progress --hide-modules --config=node_modules/laravel-mix/setup/webpack.config.js",
        "watch": "cross-env NODE_ENV=development node_modules/webpack/bin/webpack.js --watch --progress --hide-modules --config=node_modules/laravel-mix/setup/webpack.config.js",
        "watch-poll": "npm run watch -- --watch-poll",
        "hot": "cross-env NODE_ENV=development node_modules/webpack-dev-server/bin/webpack-dev-server.js --inline --hot --config=node_modules/laravel-mix/setup/webpack.config.js",
        "prod": "npm run production",
        "production": "cross-env NODE_ENV=production node_modules/webpack/bin/webpack.js --no-progress --hide-modules --config=node_modules/laravel-mix/setup/webpack.config.js"
    }
}
```

## 6. 解决 "/home/vagrant/code/sample/node_modules/pngquant-bin: Command failed." 问题

[参考](https://laravel-china.org/topics/14957/solve-error-homevagrantcodesamplenode-modulespngquant-bin-command-failed)

>错误详情：

``` bash
error /home/vagrant/code/sample/node_modules/pngquant-bin: Command failed.
Exit code: 1
Command: node lib/install.js
Arguments:
Directory: /home/vagrant/code/sample/node_modules/pngquant-bin
Output:
⚠ The `/home/vagrant/code/sample/node_modules/pngquant-bin/vendor/pngquant` binary doesn't seem to work correctly
  ⚠ pngquant pre-build test failed
  ℹ compiling from source
  ✔ pngquant pre-build test passed successfully
  ✖ Error: pngquant failed to build, make sure that libpng-dev is installed
```

>解决方法：

```bash
wget -q -O /tmp/libpng12.deb http://mirrors.kernel.org/ubuntu/pool/main/libp/libpng/libpng12-0_1.2.54-1ubuntu1_amd64.deb   && sudo dpkg -i /tmp/libpng12.deb   && rm /tmp/libpng12.deb
yarn install --no-bin-links
```

## 7. 配置信息

* 修改`.env`的`APP_NAME`为项目名称
* 修改`.env`的`APP_URL`为项目URL
* 修改`config/app.php`的`timezone`为上海时区：`'timezone' => 'Asia/Shanghai',`
* 修改`config/app.php`的`locale`为中文：`'locale' => 'zh-CN',`